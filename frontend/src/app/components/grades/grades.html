<div class="p-10">
  <div class="w-full flex">
    <div class="text-blue-700/80 font-bold text-3xl flex">
      <i class="fa-solid fa-chart-bar mr-2"></i>
      <h1>Grades Management</h1>
    </div>
    <button
      (click)="bulkUpdate()"
      class="text-white bg-blue-600 ml-auto border border-slate-300 rounded-md p-3 cursor-pointer">
      <i class="fa-solid fa-upload"></i>
      Bulk grade update
    </button>
  </div>
  <hr class="w-full text-slate-300 shadow-md border-[0.5px] my-6">

  <form class="w-full">

    <div class="w-full gap-8 mb-7 flex justify-between">
      <div class="w-full">
        <h4 class="p-2">Filter by course</h4>
        <select
          name="course"
          [(ngModel)]="selectedCourse"
          (change)="applyFilters()"
          class="p-2 w-full border rounded-md"
        >
          <option value="">All Courses</option>
          <option *ngFor="let c of courses" [value]="c">
            {{ c }}
          </option>
        </select>
      </div>
      <div class="w-full">
        <h4 class="p-2">Grade range</h4>
        <select
          name="grade"
          [(ngModel)]="selectedGradeRange"
          (change)="applyFilters()"
          class="p-2 w-full border rounded-md"
        >
          <option value="">All Grades</option>
          <option value="A">90-100 (A)</option>
          <option value="B">80-89 (B)</option>
          <option value="C">70-79 (C)</option>
          <option value="D">60-69 (D)</option>
          <option value="E">50-59 (E)</option>
          <option value="F">Below 50</option>
        </select>
      </div>
    </div>
  </form>

  <table class="w-full my-10">
    <thead class="table-header">
      <th class="table-cell">Student ID</th>
      <th class="table-cell">Name</th>
      <th class="table-cell">Course</th>
      <th class="table-cell">Current Grade</th>
      <th class="table-cell">Letter Grade</th>
      <th class="table-cell">Performance</th>
      <th class="table-cell">Actions</th>
    </thead>

    <tbody>
      <ng-container *ngFor="let g of filteredGrades; trackBy: trackByGrade">
        <tr [class.bg-yellow-100]="isModified(g)">
          <td class="py-4 pl-8">{{ g.student_id }}</td>
          <td class="py-4 pl-8">{{ g.student_name }}</td>
          <td class="py-4 pl-20">{{ g.course_name }}</td>
          <!-- <td class="py-4 pl-20">{{ g.grade_numeric }}</td> -->
          <td>
            <input
              type="text"
              inputmode="numeric"
              [(ngModel)]="g.grade_numeric"
              (blur)="onGradeChange(g)"
               [disabled]="isUpdating"
              class="border border-gray-300 p-1 w-20 rounded">
          </td>
          <td class="py-4 pl-18">{{ g.grade_letter }}</td>
          <td class="py-4 pl-10">{{ g.performance }}</td>
          <td class="flex items-center justify-center gap-2 px-4 py-4">
            <button
              class="bg-cyan-500/80 w-[80px] p-2 text-white border rounded-md"
              (click)="toggleView(g)">
              <i class="fa-solid fa-eye"></i> View
            </button>
            <button class="bg-orange-400 w-[80px] p-2 text-white border rounded-md btn btn-warning"
            (click)="editGrade(g)">
              <i class="fa-solid fa-pen-to-square"></i>
              Edit
            </button>
            <button
                class="bg-red-600/80 w-[90px] p-2 text-white rounded-md"
                (click)="deleteGrade(g)">
                <i class="fa-solid fa-trash"></i> Delete
            </button>
          </td>
        </tr>

        <tr *ngIf="isExpanded(g)">
          <td colspan="7" class="bg-slate-100 px-8 py-6">
            <div class="text-sm">
              <p><strong>Instructor:</strong> {{ g.instructor }}</p>
            </div>
          </td>
        </tr>
      </ng-container>
      <tr *ngIf="filteredGrades.length === 0">
        <td colspan="7" class="text-center text-slate-500 py-10">
          No grades found.
        </td>
      </tr>
    </tbody>
  </table>
  <div *ngIf="selectedGrade" 
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">

    <div class="bg-white p-6 rounded-lg w-[400px] shadow-lg relative">

      <h3 class="text-xl font-bold mb-4">Instructor Details</h3>

      <p class="mb-6">
        <strong>Instructor:</strong> {{ selectedGrade.instructor }}
      </p>

      <button
        class="bg-blue-600 text-white px-4 py-2 rounded-md w-full"
        (click)="selectedGrade = null">
        Close
      </button>

    </div>
  </div>
  <div *ngIf="editingGrade" class="modal bg-white p-6 shadow-lg rounded-md">
    <h3 class="text-xl font-bold mb-4">Edit Grade</h3>

    <p><strong>Student:</strong> {{ editingGrade.student_name }}</p>
    <p><strong>Course:</strong> {{ editingGrade.course_name }}</p>

    <div class="mt-4">
      <label>Numeric Grade</label>
      <input type="number"
            [(ngModel)]="editingGrade.grade_numeric"
            class="border p-2 w-full mb-3" />

      <label>Letter Grade</label>
      <input type="text"
            [(ngModel)]="editingGrade.grade_letter"
            class="border p-2 w-full mb-3" />

      <label>Performance</label>
      <input type="text"
            [(ngModel)]="editingGrade.performance"
            class="border p-2 w-full mb-4" />
    </div>

    <div class="flex gap-4">
      <button class="bg-green-600 text-white px-4 py-2 rounded"
              (click)="saveEdit()">
        Save
      </button>

      <button class="bg-gray-400 text-white px-4 py-2 rounded"
              (click)="cancelEdit()">
        Cancel
      </button>
    </div>
  </div>


  <div class="bg-slate-300/20 p-5 border border-slate-300 rounded-md">
    <h3 class="text-xl font-bold pb-5">Grade Distribution</h3>
    <div class="flex justify-between">
      <div class="bg-white w-[390px] border border-white rounded-md">
        <p class="text-green-500 font-bold p-3 flex justify-center">A (90-100)</p>
        <h2 class="text-3xl font-bold p-3 flex justify-center">0</h2>
        <p class="text-slate-500 p-3 flex justify-center">students</p>
      </div>
      <div class="bg-white w-[390px] border border-white rounded-md">
        <p class="text-blue-500 font-bold p-3 flex justify-center">B (80-89)</p>
        <h2 class="text-3xl font-bold p-3 flex justify-center">0</h2>
        <p class="text-slate-500 p-3 flex justify-center">students</p>
      </div>
      <div class="bg-white w-[390px] border border-white rounded-md">
        <p class="text-amber-500 font-bold p-3 flex justify-center">C (70-79)</p>
        <h2 class="text-3xl font-bold p-3 flex justify-center">0</h2>
        <p class="text-slate-500 p-3 flex justify-center">students</p>
      </div>
    </div>
    <div class="flex justify-between py-4">
      <div class="bg-white w-[390px] border border-white rounded-md">
        <p class="text-orange-500 font-bold p-3 flex justify-center">D (60-69)</p>
        <h2 class="text-3xl font-bold p-3 flex justify-center">0</h2>
        <p class="text-slate-500 p-3 flex justify-center">students</p>
      </div>
      <div class="bg-white w-[390px] border border-white rounded-md">
        <p class="text-red-500 font-bold p-3 flex justify-center">E (50-59)</p>
        <h2 class="text-3xl font-bold p-3 flex justify-center">0</h2>
        <p class="text-slate-500 p-3 flex justify-center">students</p>
      </div>
      <div class="bg-white w-[390px] border border-white rounded-md">
        <p class="text-stone-500 font-bold p-3 flex justify-center">F (Below 50)</p>
        <h2 class="text-3xl font-bold p-3 flex justify-center">0</h2>
        <p class="text-slate-500 p-3 flex justify-center">students</p>
      </div>
    </div>
  </div>
</div>
<ng-template #loading>
  <tr>
    <td colspan="7" class="text-center text-slate-500 py-10">
      Loading grades...
    </td>
  </tr>
</ng-template>
